@startuml
title Регистрация пользователя и обработка ошибок (все вызовы к Keycloak от API)

actor "Пользователь" as User
participant "Individual-API" as API
participant "PersonService" as PS
participant "PersonDB" as DB
participant "Keycloak" as KC

== Успешная регистрация ==
User -> API : Ввод регистрационных данных
API -> PS : Передача данных для обработки
PS -> DB : Сохранение данных пользователя
DB --> PS : Ответ: статус 200 (данные сохранены)
PS --> API : Ответ: данные сохранены
API -> KC : Запрос на генерацию Access/Refresh токенов (для пользователя)
KC --> API : Ответ: токены + статус 200
API --> User : Ответ: токены (регистрация успешна)

== Ошибка при генерации токена или недоступность Keycloak ==
API -> KC : Запрос на генерацию токенов
alt Ошибка генерации или Keycloak недоступен
    KC --> API : Ошибка: токен не сгенерирован (5xx/timeout)
    API -> PS : Запрос на удаление данных пользователя (rollback)
    PS -> DB : Удаление данных пользователя по ID
    DB --> PS : Ответ: статус 200 (данные удалены)
    PS --> API : Ответ: данные удалены
    API --> User : Ошибка: регистрация не удалась. Попробуйте позже.
end

== Ошибка при сохранении в БД ==
User -> API : Ввод регистрационных данных
API -> PS : Передача данных для обработки
PS -> DB : Сохранение данных пользователя
DB --> PS : Ошибка: не удалось сохранить (например, 500 или 409)
PS --> API : Ошибка: регистрация не удалась (данные не сохранены)
API --> User : Ошибка: регистрация не удалась. Попробуйте позже.

== Частичная выдача токенов (только Access Token) ==
API -> KC : Запрос на генерацию Access/Refresh токенов
KC --> API : Ответ: только Access Token, Refresh не выдан (например, 206 Partial Content)
API --> User : Предупреждение: токены получены частично (только Access)

@enduml